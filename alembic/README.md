# Using SQLAlchemy with Alembic

Generic single-database configuration.

[Alembic](http://alembic.zzzcomputing.com/en/latest/) is a lightweight database migration tool for usage with the SQLAlchemy Database Toolkit for Python.



[TOC]

## Start Alembic

```shell
$ alembic init alembic

myproject/
├── myproject/
└── alembic/
    ├── versions
    └── env.py
    └── README
    └── script.py.mako
└── alembic.ini
```

- `alembic.ini`


- `alembic/env.py`

  if you want to execute auto migration, set *target_metadata*.



> **`alembic_version`**
>
> When you execute alembic, `alembic_version` table will be created in your database.





## Migration

1. Create Revision File

```shell
$ alembic revision -m "put your message"
```

An empty file is created in `alembic/versions/`, and modify the file.



```shell
$ alembic revision --autogenerate -m "put your message"
```

Auto generate revision is made by automatically reflecting the modified `alembic/env.py/target_metadata`. 



2. Execute Migration

```shell
$ alembic upgrade head
```



- Check migration log

```shell
$ alembic histoy --verbose
```





## Adding an existing DATABASE to the Alembic version

### Method 1: Move A to B
1. Set Alembic init

- alembic.ini
```ini
# new schema(empty schema)
sqlalchemy.url = driver://user:pass@localhost/dbname
```



2. Set Alembic target metadata
- alembic/env.py
```
from sqlalchemy import create_engine, MetaData
from sqlalchemy.ext.declarative import declarative_base

#: set schema to copy(already created schema)
url = 'driver://user:pass@localhost/dbname'

engine = create_engine(url)
conn = engine.connect()
Base = declarative_base(metadata=MetaData(bind=engine))
Base.metadata.reflect(engine)

target_metadata = Base.metadata
```



3. Execute Alembic Command
```python
$ alembic revision --autogenerate -m "initial_migration"

> A file will be created at alembic/versions/
"""initial_migration

Revision ID: df4737142c76
Revises:
Create Date: 2018-02-28 12:13:45.925329

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql

# revision identifiers, used by Alembic.
revision = 'df4737142c76'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('table_name',
    sa.Column('col1', mysql.INTEGER(display_width=11), nullable=False),
    sa.Column('col2', mysql.INTEGER(display_width=11), autoincrement=False, nullable=True),
    sa.Column('col3', mysql.VARCHAR(length=45), nullable=True),
    sa.Column('col4', mysql.TIMESTAMP(), nullable=True),
    sa.PrimaryKeyConstraint('col1'),
    mysql_default_charset='utf8',
    mysql_engine='InnoDB'
    )
    ...
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('fk_col1_idx', table_name='trans_comments')
    op.drop_table('table_name')
    ...
    # ### end Alembic commands ###
```
`alembic_version` table is created in dbname set in alembic.ini.



### Method 2: Adding with raw SQL statements

1. Create a Migration Script

```sh
$ alembic revision -m "put your message"

"""put your message

Revision ID: 857aba65dcb1
Revises: 09d2c7143f9d
Create Date: 2018-02-28 14:54:39.666241

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '857aba65dcb1'
down_revision = '09d2c7143f9d'
branch_labels = None
depends_on = None


def upgrade():
    pass


def downgrade():
    pass

```



2. Modify as you like

```python
def upgrade():
    conn = op.get_bind()
    conn.execute("""
    CREATE TABLE `table_name` (
    `col1` int(11) NOT NULL AUTO_INCREMENT,
    `col2` int(11) DEFAULT NULL,
    `col3` varchar(45) DEFAULT NULL,
    `col4` timestamp NULL DEFAULT NULL,
    PRIMARY KEY (`col1`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    """)
```





## Output Alembic revision as a raw SQL statement

```
$ alembic upgrade `Revision ID` --sql > migration.sql
```
